<!-- public/index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <style>
    body { background-color: #007bff; color: white; font-family: Arial, sans-serif; margin: 0; }
    #login, #chat { padding: 20px; }
    #login { max-width: 300px; margin: 50px auto; }
    #chat { display: flex; height: 100vh; }
    #contacts { width: 200px; border-right: 1px solid #003380; overflow-y: auto; }
    #contacts li { padding: 10px; cursor: pointer; }
    #contacts li:hover, #contacts li.active { background-color: #0056b3; }
    #messages { flex: 1; display: flex; flex-direction: column; }
    #msgList { flex: 1; overflow-y: auto; padding: 10px; }
    #newMsg { display: flex; }
    #newMsg input[type=text] { flex: 1; padding: 10px; font-size: 16px; border: none; outline: none; }
    #newMsg button { padding: 10px 15px; background: #0056b3; border: none; color: white; cursor: pointer; }
    #newMsg button:hover { background: #004494; }
    .message { margin-bottom: 10px; }
    .message strong { display: block; }
    #photoInput { display: none; }
  </style>
</head>
<body>
  <div id="login">
    <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="btnLogin">–í–æ–π—Ç–∏</button>
    <button id="btnRegister">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <p id="loginMsg"></p>
  </div>

  <div id="chat" style="display:none;">
    <ul id="contacts"></ul>
    <div id="messages">
      <div id="msgList"></div>
      <div id="newMsg">
        <input id="msgInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" />
        <button id="btnSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="btnPhoto">üì∑</button>
        <input id="photoInput" type="file" accept="image/*" />
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = null;
    let activeContact = null;
    const usersMessages = {};

    const loginSection = document.getElementById('login');
    const chatSection = document.getElementById('chat');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const loginMsg = document.getElementById('loginMsg');
    const contactsList = document.getElementById('contacts');
    const messagesList = document.getElementById('msgList');
    const msgInput = document.getElementById('msgInput');
    const btnSend = document.getElementById('btnSend');
    const btnPhoto = document.getElementById('btnPhoto');
    const photoInput = document.getElementById('photoInput');

    btnRegister.onclick = async () => {
      const u = usernameInput.value.trim();
      const p = passwordInput.value.trim();
      if (!u || !p) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å');
      const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p })
      });
      if (res.ok) {
        loginMsg.textContent = '–£—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –≤–æ–π–¥–∏—Ç–µ.';
      } else {
        const data = await res.json();
        loginMsg.textContent = data.msg || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
      }
    };

    btnLogin.onclick = async () => {
      const u = usernameInput.value.trim();
      const p = passwordInput.value.trim();
      if (!u || !p) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å');
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p })
      });
      if (res.ok) {
        const data = await res.json();
        username = u;
        loginSection.style.display = 'none';
        chatSection.style.display = 'flex';
        socket.emit('login', username);
        updateContacts(data.contacts);
      } else {
        const data = await res.json();
        loginMsg.textContent = data.msg || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
      }
    };

    function updateContacts(contacts) {
      contactsList.innerHTML = '';
      contacts.forEach(c => {
        const li = document.createElement('li');
        li.textContent = c;
        li.onclick = () => {
          activeContact = c;
          showMessages(c);
        };
        contactsList.appendChild(li);
      });
    }

    function showMessages(contact) {
      messagesList.innerHTML = '';
      activeContact = contact;
      if (!usersMessages[contact]) usersMessages[contact] = [];
      usersMessages[contact].forEach(m => {
        addMessage(m);
      });
    }

    btnSend.onclick = () => {
      if (!activeContact) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç');
      const text = msgInput.value.trim();
      if (!text) return;
      sendMessage(activeContact, text, 'text');
      msgInput.value = '';
    };

    function sendMessage(to, text, type) {
      const msg = { from: username, text, type, time: Date.now() };
      if (!usersMessages[to]) usersMessages[to] = [];
      usersMessages[to].push(msg);
      addMessage(msg);
      socket.emit('sendMessage', { to, text, type });
    }

    socket.on('newMessage', ({ contact, message }) => {
      if (!usersMessages[contact]) usersMessages[contact] = [];
      usersMessages[contact].push(message);
      if (contact === activeContact) addMessage(message);
    });

    function addMessage({ from, text, type, time }) {
      const div = document.createElement('div');
      div.classList.add('message');
      let content = `<strong>${from}</strong>: `;
      if (type === 'text') content += text;
      else if (type === 'photo') content += `<br><img src="${text}" style="max-width:200px">`;
      div.innerHTML = content;
      messagesList.appendChild(div);
      messagesList.scrollTop = messagesList.scrollHeight;
    }

    btnPhoto.onclick = () => photoInput.click();

    photoInput.onchange = async () => {
      if (!photoInput.files.length) return;
      const file = photoInput.files[0];
      const formData = new FormData();
      formData.append('photo', file);
      const res = await fetch('/upload', { method: 'POST', body: formData });
      if (res.ok) {
        const data = await res.json();
        sendMessage(activeContact, data.url, 'photo');
      }
      photoInput.value = '';
    };

    // –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–≤–æ–Ω–∫–∞ (–∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
    socket.on('incomingCall', ({ from }) => {
      if (confirm(`–ó–≤–æ–Ω–æ–∫ –æ—Ç ${from}. –ü—Ä–∏–Ω—è—Ç—å?`)) {
        alert('–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ç—É—Ç –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å)');
      } else {
        alert('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
      }
    });
  </script>
</body>
</html>
