<!DOCTYPE html>
<html>
<head>
  <title>Чат</title>
  <style>
    body {
      background-color: #007bff;
      color: white;
      font-family: Arial, sans-serif;
    }
    #chat-window {
      height: 300px;
      overflow-y: scroll;
      border: 1px solid white;
      padding: 10px;
      margin-bottom: 10px;
    }
    #room-selector {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h2>Вход / Регистрация</h2>

<div id="login-section">
  <input type="text" id="username" placeholder="Имя пользователя" />
  <input type="password" id="password" placeholder="Пароль" />
  <button id="login-btn">Войти</button>
  <button id="register-btn">Регистрация</button>
  <p id="login-msg"></p>
</div>

<div id="chat-section" style="display:none;">
  <select id="room-selector">
    <option value="friend">Чат с другом</option>
    <option value="girlfriend">Чат с подругой</option>
  </select>

  <div id="chat-window"></div>

  <input type="text" id="message-input" placeholder="Введите сообщение" />
  <button id="send-btn">Отправить</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  let username = null;
  let currentRoom = 'friend';

  const loginSection = document.getElementById('login-section');
  const chatSection = document.getElementById('chat-section');
  const loginMsg = document.getElementById('login-msg');
  const roomSelector = document.getElementById('room-selector');
  const chatWindow = document.getElementById('chat-window');

  document.getElementById('register-btn').onclick = async () => {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if (!u || !p) return alert('Введите имя и пароль');

    const res = await fetch('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: u, password: p }),
    });

    if (res.ok) {
      loginMsg.textContent = 'Регистрация прошла успешно, войдите';
    } else {
      const data = await res.json();
      loginMsg.textContent = data.msg || 'Ошибка регистрации';
    }
  };

  document.getElementById('login-btn').onclick = async () => {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if (!u || !p) return alert('Введите имя и пароль');

    const res = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: u, password: p }),
    });

    if (res.ok) {
      username = u;
      loginSection.style.display = 'none';
      chatSection.style.display = 'block';
      joinRoom(currentRoom);
    } else {
      const data = await res.json();
      loginMsg.textContent = data.msg || 'Ошибка входа';
    }
  };

  roomSelector.onchange = () => {
    joinRoom(roomSelector.value);
  };

  function joinRoom(room) {
    if (currentRoom) {
      socket.emit('leaveRoom', currentRoom);
    }
    currentRoom = room;
    chatWindow.innerHTML = '';
    socket.emit('joinRoom', { username, room });
  }

  document.getElementById('send-btn').onclick = () => {
    const msgInput = document.getElementById('message-input');
    const msg = msgInput.value.trim();
    if (!msg) return;
    socket.emit('chatMessage', msg);
    msgInput.value = '';
  };

  socket.on('message', ({ user, text }) => {
    const msgDiv = document.createElement('div');
    msgDiv.textContent = `${user}: ${text}`;
    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  });
</script>

</body>
</html>
