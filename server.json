// server.js
const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');
const bcrypt = require('bcrypt');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);

app.use(express.static(__dirname)); // â† Ñ€Ð°Ð·Ð´Ð°Ñ‘Ñ‚ ÑÑ‚Ð°Ñ‚Ð¸ÐºÑƒ

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});
// Ð‘Ð°Ð·Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ð¿Ð°Ð¼ÑÑ‚Ð¸ (Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ â€” Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…)
const users = new Map(); // nickname â†’ { hashedPassword, socketId }
const sessions = new Map(); // socketId â†’ nickname

// === ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚: Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ===
app.post('/register', async (req, res) => {
    const { nickname, password } = req.body;

    if (!nickname || !password) {
        return res.status(400).json({ error: 'ÐÐ¸Ðº Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹' });
    }

    if (users.has(nickname)) {
        return res.status(409).json({ error: 'Ð¢Ð°ÐºÐ¾Ð¹ Ð½Ð¸Ðº ÑƒÐ¶Ðµ Ð·Ð°Ð½ÑÑ‚' });
    }

    const hashedPassword = await bcrypt.hash(password, 10);
    users.set(nickname, { hashedPassword, socketId: null });

    console.log(`âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½: ${nickname}`);
    res.status(201).json({ success: true });
});

// === ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚: Ð’Ñ…Ð¾Ð´ ===
app.post('/login', async (req, res) => {
    const { nickname, password } = req.body;

    const userData = users.get(nickname);
    if (!userData) {
        return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }

    const isMatch = await bcrypt.compare(password, userData.hashedPassword);
    if (!isMatch) {
        return res.status(401).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }

    res.json({ success: true });
});

// === Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° ===
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

// === Socket.IO ===
io.on('connection', (socket) => {
    console.log('ðŸ”Œ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ:', socket.id);

    // ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð¾Ð±Ñ‰Ð°ÐµÑ‚ ÑÐ²Ð¾Ð¹ Ð½Ð¸Ðº Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ…Ð¾Ð´Ð°
    socket.on('authenticate', (nickname) => {
        if (!users.has(nickname)) return;

        const userData = users.get(nickname);
        userData.socketId = socket.id;
        sessions.set(socket.id, nickname);

        console.log(`ðŸŸ¢ ${nickname} Ð²Ð¾ÑˆÑ‘Ð» Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ`);
        socket.emit('auth-success', { nickname });
    });

    // ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾ Ð½Ð¸ÐºÑƒ
    socket.on('search-user', (nickname) => {
        const found = users.has(nickname) && users.get(nickname).socketId !== null;
        socket.emit('search-result', { nickname, online: found });
    });

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    socket.on('private-message', ({ to, message }) => {
        const userData = users.get(to);
        const from = sessions.get(socket.id);

        if (!from) return;

        if (userData && userData.socketId) {
            // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŽ
            io.to(userData.socketId).emit('private-message', {
                from,
                message
            });
            // ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ
            socket.emit('message-sent', { to, message });
        } else {
            socket.emit('error', { message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð² ÑÐµÑ‚Ð¸ Ð¸Ð»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚' });
        }
    });

    // ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
    socket.on('disconnect', () => {
        const nickname = sessions.get(socket.id);
        if (nickname) {
            const userData = users.get(nickname);
            if (userData) userData.socketId = null;
            sessions.delete(socket.id);
            console.log(`ðŸ”´ ${nickname} Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ð»ÑÑ`);
        }
    });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log(`ðŸš€ Pros.to Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});
